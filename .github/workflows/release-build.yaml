name: Release Build

on:
    push:
        branches: [ "release/**" ]
    create:
        branches: [ "release/**" ]

jobs:
    build-apks:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Cache Gradle packages
                uses: actions/cache@v4
                with:
                    path: |
                        ~/.gradle/caches
                        ~/.gradle/wrapper
                    key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/buildSrc/**/*.kt') }}
                    restore-keys: |
                        ${{ runner.os }}-gradle-

            -   name: set up JDK 17
                uses: actions/setup-java@v4
                with:
                    java-version: '17'
                    distribution: 'temurin'
                    cache: gradle

            -   name: Add Local Properties
                env:
                    KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
                    KAKAO_JS_KEY: ${{ secrets.KAKAO_JS_KEY }}
                run: |
                    echo KAKAO_REST_API_KEY=$KAKAO_REST_API_KEY > ./local.properties
                    echo KAKAO_JS_KEY=$KAKAO_JS_KEY >> ./local.properties

            -   name: Grant execute permission for gradlew
                run: chmod +x gradlew

            -   name: Get version name
                id: version
                run: |
                    VERSION_NAME=$(./gradlew -q printVersionName)
                    echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
                    echo "tag_name=v$VERSION_NAME-$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

            -   name: Build Debug APK
                run: ./gradlew assembleDebug

            -   name: Build Release APK
                run: ./gradlew assembleRelease

            -   name: Create GitHub Release
                uses: softprops/action-gh-release@v1
                with:
                    tag_name: ${{ steps.version.outputs.tag_name }}
                    name: Release ${{ steps.version.outputs.version_name }}
                    body: |
                        ## ðŸš€ Release Build ${{ steps.version.outputs.version_name }}

                        ### ðŸ“± APK ë‹¤ìš´ë¡œë“œ
                        - **Release APK**: í”„ë¡œë•ì…˜ìš© ë¹Œë“œ (ê¶Œìž¥)
                        - **Debug APK**: ê°œë°œìš© ë¹Œë“œ

                        ### ðŸ“‹ ì„¤ì¹˜ ë°©ë²•
                        1. ì•„ëž˜ Assetsì—ì„œ APK íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                        2. Android ê¸°ê¸°ì—ì„œ "ì•Œ ìˆ˜ ì—†ëŠ” ì¶œì²˜" í—ˆìš©
                        3. APK íŒŒì¼ ì‹¤í–‰í•˜ì—¬ ì„¤ì¹˜

                        ### âš ï¸ ì£¼ì˜ì‚¬í•­
                        - ì´ ì•±ì€ ë² íƒ€ ë²„ì „ìž…ë‹ˆë‹¤
                        - ì‚¬ìš© ì¤‘ ë¬¸ì œê°€ ë°œìƒí•˜ë©´ Issuesì— ì‹ ê³ í•´ì£¼ì„¸ìš”
                    draft: false
                    prerelease: true
                    files: |
                        ./app/build/outputs/apk/release/[Brake_release_v${{ steps.version.outputs.version_name }}]_*.apk
                        ./app/build/outputs/apk/debug/[Brake_debug_v${{ steps.version.outputs.version_name }}]_*.apk

            -   name: Create Release Summary
                run: |
                    echo "## ðŸš€ Release Build Summary" >> $GITHUB_STEP_SUMMARY
                    echo "### ðŸ“‹ Release Information" >> $GITHUB_STEP_SUMMARY
                    echo "- **Tag**: \`${{ steps.version.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
                    echo "- **Version**: \`${{ steps.version.outputs.version_name }}\`" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "### Debug APK" >> $GITHUB_STEP_SUMMARY
                    echo "- íŒŒì¼: \`$(basename app/build/outputs/apk/debug/[Brake_debug_v${{ steps.version.outputs.version_name }}]_*.apk)\`" >> $GITHUB_STEP_SUMMARY
                    echo "- í¬ê¸°: \`$(du -h app/build/outputs/apk/debug/[Brake_debug_v${{ steps.version.outputs.version_name }}]_*.apk | cut -f1)\`" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "### Release APK" >> $GITHUB_STEP_SUMMARY
                    echo "- íŒŒì¼: \`$(basename app/build/outputs/apk/release/[Brake_release_v${{ steps.version.outputs.version_name }}]_*.apk)\`" >> $GITHUB_STEP_SUMMARY
                    echo "- í¬ê¸°: \`$(du -h app/build/outputs/apk/release/[Brake_release_v${{ steps.version.outputs.version_name }}]_*.apk | cut -f1)\`" >> $GITHUB_STEP_SUMMARY
