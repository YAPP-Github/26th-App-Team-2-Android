name: Pull Request CI

on:
  pull_request:
    branches: [ "main", "develop" ]
  push:

jobs:
  build:
    name: Check Code Quality and Build
    runs-on: ubuntu-latest

    steps:
      -   name: Checkout code
          uses: actions/checkout@v4

      -   name: Cache Gradle packages
          uses: actions/cache@v4
          with:
            path: |
              ~/.gradle/caches
              ~/.gradle/wrapper
            key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/buildSrc/**/*.kt') }}
            restore-keys: |
              ${{ runner.os }}-gradle-

      -   name: set up JDK 17
          uses: actions/setup-java@v4
          with:
            java-version: '17'
            distribution: 'temurin'
            cache: gradle

      -   name: Add Local Properties
          env:
              KAKAO_NATIVE_APP_KEY: ${{ secrets.KAKAO_NATIVE_APP_KEY }}
          run: |
              echo KAKAO_NATIVE_APP_KEY=KAKAO_NATIVE_APP_KEY > ./local.properties

      -   name: Grant execute permission for gradlew
          run: chmod +x gradlew

      -   name: Build Check
          run: ./gradlew build

      -   name: Detekt Check
          run: ./gradlew detekt

      -   name: Set up SSH
          run: |
              mkdir -p ~/.ssh
              echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
              chmod 600 ~/.ssh/id_rsa
              ssh-keyscan github.com >> ~/.ssh/known_hosts

      -   name: Push via Deploy Key
          run: |
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git add .
              git diff --cached --quiet || git commit -m "chore: ci 자동 ktlintFormat 적용"
              git remote set-url origin git@github.com:${{ github.repository }}.git
              git push origin HEAD:${GITHUB_REF_NAME}
